# Angler Power Monitor — Прошивка для ESP8266/ESP32

Прошивка для моніторингу електроживлення. Пристрій підключається до сервера [angler.com.ua](https://angler.com.ua) і надсилає сповіщення в Telegram, коли зникає або з'являється світло.

---

## Що потрібно

- Плата ESP8266 (NodeMCU, Wemos D1 Mini) або ESP32 (DevKit, NodeMCU-32S)
- USB-кабель для підключення до комп'ютера
- WiFi мережа
- Комп'ютер з Windows, Mac або Linux
- Telegram для отримання сповіщень

---

## Крок 1. Отримайте токен пристрою

1. Відкрийте Telegram
2. Знайдіть бота [@angler_energy_bot](https://t.me/angler_energy_bot)
3. Напишіть `/start` і додайте новий пристрій
4. Бот видасть вам токен — збережіть його, він знадобиться далі

---

## Крок 2. Встановіть Arduino IDE

1. Завантажте Arduino IDE з [arduino.cc/en/software](https://www.arduino.cc/en/software)
2. Встановіть та відкрийте програму

---

## Крок 3. Додайте підтримку вашої плати

Arduino IDE за замовчуванням не знає про ESP8266/ESP32. Потрібно додати:

1. Відкрийте **File → Preferences** (або Arduino IDE → Settings на Mac)
2. Знайдіть поле **Additional Boards Manager URLs**
3. Вставте одну з посилань (або обидва через кому):
   - Для ESP8266: `https://arduino.esp8266.com/stable/package_esp8266com_index.json`
   - Для ESP32: `https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json`
4. Натисніть OK
5. Відкрийте **Tools → Board → Boards Manager**
6. Знайдіть і встановіть:
   - Для ESP8266: пакет **esp8266** by ESP8266 Community
   - Для ESP32: пакет **esp32** by Espressif Systems

### Можливі проблеми на цьому кроці

**Preferences не відкривається або налаштування не зберігаються**
- Причина: шлях до папки Arduino містить кириличні (українські/російські) символи
- Рішення: перемістіть папку Arduino в місце без кирилиці, наприклад `C:\Arduino` або `D:\Arduino`
- Також перевірте що ім'я користувача Windows не містить кирилиці (папка `C:\Users\Ім'я`)

**Не встановлюється остання версія (наприклад 3.3.5, а ставиться 3.3.4)**
- Це нормально — іноді остання версія має проблеми
- Використовуйте версію що встановилась, вона буде працювати
- Якщо потрібна конкретна версія: натисніть на випадаючий список версій біля кнопки Install

**Boards Manager довго завантажується або видає помилку**
- Перевірте інтернет-з'єднання
- Спробуйте вимкнути VPN або проксі
- Видаліть кеш: закрийте Arduino IDE, видаліть папку `C:\Users\ВашеІм'я\AppData\Local\Arduino15\staging` і спробуйте знову

**Не бачу ESP8266/ESP32 в списку плат після встановлення**
- Перезапустіть Arduino IDE
- Переконайтеся що пакет дійсно встановився (зелена галочка в Boards Manager)

**Помилка "Error downloading" при встановленні**
- Скопіюйте URL з пункту 3 в браузер — якщо не відкривається, проблема з інтернетом або блокуванням
- Спробуйте змінити DNS на 8.8.8.8 (Google) або 1.1.1.1 (Cloudflare)

---

## Крок 4. Налаштуйте прошивку

1. Завантажте цей репозиторій (кнопка Code → Download ZIP) і розпакуйте
2. Відкрийте папку вашої плати:
   - `esp8266/` — для ESP8266, NodeMCU, Wemos D1
   - `esp32/` — для ESP32, NodeMCU-32S
3. Відкрийте файл `config.h` в текстовому редакторі
4. Заповніть свої дані:

```c
const char* WIFI_SSID = "Назва_вашої_WiFi_мережі";
const char* WIFI_PASSWORD = "Пароль_від_WiFi";
const char* SERVER_URL = "https://api.angler.com.ua";
const char* DEVICE_TOKEN = "Токен_з_Telegram_бота";
```

5. Збережіть файл

---

## Крок 5. Завантажте прошивку на плату

1. Підключіть плату до комп'ютера через USB
2. Відкрийте файл `.ino` з папки вашої плати в Arduino IDE
3. Оберіть вашу плату: **Tools → Board** → виберіть вашу модель
   - Для NodeMCU ESP8266: `NodeMCU 1.0 (ESP-12E Module)`
   - Для Wemos D1: `LOLIN(WEMOS) D1 R2 & mini`
   - Для ESP32 DevKit: `ESP32 Dev Module`
4. Оберіть порт: **Tools → Port** → виберіть COM-порт вашої плати
5. Натисніть кнопку **Upload** (стрілка вправо)
6. Дочекайтеся завершення завантаження

Готово! Пристрій почне працювати автоматично.

---

## Як зрозуміти що пристрій працює

Вбудований світлодіод на платі показує стан:

| Що бачите | Що це означає |
|-----------|---------------|
| Коротке моргання раз на 30 сек | Все добре, пристрій працює |
| Часте моргання | Підключення до WiFi |
| Світлодіод горить постійно | Проблема з токеном |

---

## Як це працює

1. Пристрій підключається до WiFi
2. Кожні 30 секунд відправляє сигнал "я живий" на сервер
3. Якщо сигнал не надходить більше 100 секунд — сервер розуміє що зникло світло
4. Telegram-бот надсилає вам сповіщення
5. Коли світло повертається — пристрій перезавантажується і знову виходить на зв'язок
6. Бот повідомляє що світло з'явилось

---

## Вирішення проблем

**Пристрій не підключається до WiFi**
- Перевірте правильність назви мережі та пароля в `config.h`
- Переконайтеся що WiFi працює на частоті 2.4 GHz (5 GHz не підтримується)
- Спробуйте перезавантажити роутер

**Світлодіод горить постійно**
- Токен невірний або вже використовується іншим пристроєм
- Видаліть пристрій в боті і створіть новий з новим токеном

**Помилка при завантаженні прошивки**
- Переконайтеся що обрали правильну плату і порт
- Спробуйте інший USB-кабель (деякі кабелі тільки для зарядки)
- Перезапустіть Arduino IDE

**Помилка "A fatal error occurred: Failed to connect to ESP32"**
- Затисніть кнопку BOOT на платі під час завантаження
- Спробуйте зменшити швидкість: Tools → Upload Speed → 115200

**Помилка "espcomm_upload_mem failed" (ESP8266)**
- Затисніть кнопку FLASH під час завантаження (якщо є)
- Оберіть правильну плату в меню Tools → Board

**Порт не відображається в списку**
- Спробуйте перезапустити Arduino IDE — часто допомагає
- Від'єднайте та під'єднайте USB-кабель
- Встановіть драйвер CH340 (для більшості китайських плат): [посилання](https://www.wch-ic.com/downloads/CH341SER_EXE.html)
- Або драйвер CP2102 (для оригінальних плат): [посилання](https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers)
- Перезавантажте комп'ютер після встановлення драйвера

**Компіляція зупиняється з помилкою**
- Перевірте що встановили правильний Board Package (esp8266 або esp32)
- Переконайтеся що відкрили .ino файл з правильної папки (esp8266 або esp32)

**Сповіщення не приходять**
- Увімкніть сповіщення від бота в Telegram
- Перевірте що пристрій моргає (працює)

---

## Додаткові налаштування

В файлі `config.h` можна змінити:

| Параметр | Значення за замовчуванням | Опис |
|----------|---------------------------|------|
| `HEARTBEAT_INTERVAL` | 30000 (30 секунд) | Як часто відправляти сигнал |
| `WIFI_TIMEOUT` | 30000 (30 секунд) | Скільки чекати підключення до WiFi |
| `DEBUG_SERIAL` | 0 (вимкнено) | Увімкнути відладку через Serial Monitor |

---

## Посилання

- Сайт: [angler.com.ua](https://angler.com.ua)
- Telegram бот: [@angler_energy_bot](https://t.me/angler_energy_bot)

---

## Ліцензія

MIT License — можете використовувати як завгодно. Див. [LICENSE](LICENSE).
